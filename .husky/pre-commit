#!/bin/sh

# Pre-commit hook: Sync OpenAPI spec and TypeScript client
# Automatically generates API spec and client when backend changes are detected

set -e  # Exit on any error

# Get repo root (works from any subdirectory)
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Allow emergency skip
if [ -n "$SKIP_HOOKS" ]; then
    printf "${YELLOW}⚠ Pre-commit hook skipped via SKIP_HOOKS${NC}\n"
    exit 0
fi

printf "${YELLOW}→ Running pre-commit hooks${NC}\n"

# Detect what changed in staged files
TERRAFORM_CHANGED=$(git diff --cached --name-only | grep -E '^terraform/.*\.tf$' || true)
BACKEND_CHANGED=$(git diff --cached --name-only | grep -E '^backend/.*\.py$' || true)
OPENAPI_CHANGED=$(git diff --cached --name-only | grep 'backend/openapi.json' || true)

# Track what needs to run
SHOULD_FORMAT_TF=false
SHOULD_EXPORT=false
SHOULD_GENERATE=false

# Check if Terraform formatting needed
if [ -n "$TERRAFORM_CHANGED" ]; then
    printf "Terraform files changed, will format\n"
    SHOULD_FORMAT_TF=true
fi

# Check if API generation needed
if [ -n "$BACKEND_CHANGED" ] || [ -n "$FORCE_CODEGEN" ]; then
    printf "Backend Python files changed, will regenerate OpenAPI spec\n"
    SHOULD_EXPORT=true
    SHOULD_GENERATE=true
elif [ -n "$OPENAPI_CHANGED" ]; then
    printf "OpenAPI spec changed, will regenerate TypeScript client\n"
    SHOULD_GENERATE=true
fi

# Early exit if nothing to do (fast path)
if [ "$SHOULD_FORMAT_TF" = false ] && [ "$SHOULD_EXPORT" = false ] && [ "$SHOULD_GENERATE" = false ]; then
    printf "No changes requiring pre-commit processing\n"
    exit 0
fi

# Check command availability
check_command() {
    if ! command -v "$1" >/dev/null 2>&1; then
        printf "${RED}Error: %s not found in PATH${NC}\n" "$1"
        printf "%s\n" "$2"
        exit 1
    fi
}

# Export OpenAPI spec from backend
if [ "$SHOULD_EXPORT" = true ]; then
    printf "→ Checking dependencies...\n"
    check_command poetry "Install Poetry: https://python-poetry.org/docs/#installation"

    if [ ! -d "backend" ]; then
        printf "${RED}Error: backend/ directory not found${NC}\n"
        exit 1
    fi

    printf "→ Generating OpenAPI spec...\n"

    cd backend
    if ! poetry run python scripts/export_openapi.py 2>&1; then
        printf "${RED}✗ OpenAPI export failed${NC}\n"
        printf "\nTroubleshooting:\n"
        printf "  1. Check FastAPI app starts: poetry run python -c 'from app.main import app'\n"
        printf "  2. Check dependencies installed: poetry install\n"
        printf "  3. Review error output above\n"
        exit 1
    fi
    cd "$REPO_ROOT"

    # Verify output file exists
    if [ ! -f "backend/openapi.json" ]; then
        printf "${RED}✗ openapi.json was not created${NC}\n"
        exit 1
    fi

    printf "${GREEN}✓ OpenAPI spec generated${NC}\n"
fi

# Generate TypeScript client from OpenAPI spec
if [ "$SHOULD_GENERATE" = true ]; then
    printf "→ Checking dependencies...\n"
    check_command npm "Install Node.js: https://nodejs.org/"

    if [ ! -d "frontend/esclavizador" ]; then
        printf "${RED}Error: frontend/esclavizador/ directory not found${NC}\n"
        exit 1
    fi

    if [ ! -d "frontend/esclavizador/node_modules" ]; then
        printf "${RED}Error: node_modules not found${NC}\n"
        printf "Run: cd frontend/esclavizador && npm install\n"
        exit 1
    fi

    printf "→ Generating TypeScript client...\n"

    cd frontend/esclavizador
    if ! npm run generate-client 2>&1; then
        printf "${RED}✗ Client generation failed${NC}\n"
        printf "\nTroubleshooting:\n"
        printf "  1. Check openapi.json exists: ls ../../backend/openapi.json\n"
        printf "  2. Check @hey-api/openapi-ts installed: npm list @hey-api/openapi-ts\n"
        printf "  3. Run manually: npm run generate-client\n"
        printf "  4. Review error output above\n"
        exit 1
    fi
    cd "$REPO_ROOT"

    # Verify generated files exist
    if [ ! -d "frontend/esclavizador/lib/api/generated" ]; then
        printf "${RED}✗ Generated client files missing${NC}\n"
        exit 1
    fi

    printf "${GREEN}✓ TypeScript client generated${NC}\n"
fi

# Stage generated files
printf "→ Staging generated files...\n"
git add backend/openapi.json 2>/dev/null || true
git add frontend/esclavizador/lib/api/generated/ 2>/dev/null || true

printf "${GREEN}✓ Pre-commit hook completed successfully${NC}\n"
printf "\n"
printf "Generated files staged:\n"
printf "  - backend/openapi.json\n"
printf "  - frontend/esclavizador/lib/api/generated/\n"

exit 0
