name: API Client Sync Validation

on:
  # pull_request:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:

jobs:
  validate-api-client-sync:
    name: Validate API Client Sync
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # Backend: Setup Python and Poetry
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: poetry-${{ runner.os }}-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-

      - name: Install backend dependencies
        working-directory: backend
        run: poetry install --no-interaction

      # Backend: Generate fresh OpenAPI spec
      - name: Export OpenAPI spec from backend
        working-directory: backend
        run: poetry run python scripts/export_openapi.py

      # Frontend: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/esclavizador/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend/esclavizador
        run: npm ci

      # Frontend: Generate fresh TypeScript client
      - name: Generate TypeScript client from OpenAPI spec
        working-directory: frontend/esclavizador
        run: npm run generate-client

      # Validation: Compare with committed files
      - name: Check if API client is in sync
        run: |
          echo "Checking for differences between committed and generated files..."

          if ! git diff --quiet backend/openapi.json; then
            echo "❌ ERROR: backend/openapi.json is out of sync!"
            echo ""
            echo "The committed OpenAPI spec doesn't match the backend code."
            echo ""
            echo "To fix:"
            echo "  1. cd backend"
            echo "  2. poetry run python scripts/export_openapi.py"
            echo "  3. git add backend/openapi.json"
            echo "  4. git commit --amend (or create new commit)"
            echo ""
            echo "Differences:"
            git diff --stat backend/openapi.json
            exit 1
          fi

          if ! git diff --quiet frontend/esclavizador/lib/api/generated; then
            echo "❌ ERROR: TypeScript API client is out of sync!"
            echo ""
            echo "The committed client doesn't match the OpenAPI spec."
            echo ""
            echo "To fix:"
            echo "  1. cd frontend/esclavizador"
            echo "  2. npm run generate-client"
            echo "  3. git add lib/api/generated"
            echo "  4. git commit --amend (or create new commit)"
            echo ""
            echo "Differences:"
            git diff --stat frontend/esclavizador/lib/api/generated
            exit 1
          fi

          echo "✅ API client is in sync with backend!"

      - name: Print validation summary
        if: success()
        run: |
          echo ""
          echo "========================================="
          echo "API Client Sync Validation"
          echo "========================================="
          echo "OpenAPI spec:      ✓ In sync"
          echo "TypeScript client: ✓ In sync"
          echo "========================================="
